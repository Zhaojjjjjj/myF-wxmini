<view class="container">
  <!-- 动态3D背景 -->
  <view class="background-animation">
    <view class="shape"></view>
    <view class="shape"></view>
    <view class="shape"></view>
  </view>

  <!-- 顶部按钮 -->
  <view class="header">
    <button class="refresh-btn" bindtap="refreshRoom">
      <text class="btn-text">刷新</text>
    </button>
    <button class="invite-btn" bindtap="showInviteModal">
      <text class="btn-text">邀请</text>
    </button>
    <button class="exit-btn" bindtap="exitRoom">
      <text class="btn-text">退出</text>
    </button>
  </view>

  <!-- 成员列表 -->
  <view class="members-container">
    <view class="members-scroll">
      <view wx:for="{{members}}" wx:key="id" class="member-card" bindtap="onMemberTap" data-user-id="{{item.id}}" data-user-nickname="{{item.nickname}}" data-user-avatar="{{item.avatar_url}}">
        <image class="avatar" src="{{item.avatar_url}}" mode="aspectFill"></image>
        <text class="nickname">{{item.nickname}}</text>
        <text class="score">{{item.score}}</text>
      </view>
    </view>
  </view>

  <!-- 日志区域 -->
  <view class="logs">
    <block wx:for="{{logs}}" wx:key="id">
      <view class="log-item">
        <text class="log-text">{{item.created_at}} {{item.from_user_nickname}}转账{{item.to_user_nickname}} {{item.amount}}</text>
      </view>
    </block>
  </view>

  <!-- 邀请弹窗 -->
  <view class="modal" wx:if="{{showInviteModal}}">
    <view class="modal-content invite-modal">
      <view class="modal-title">邀请好友加入房间</view>
      <view class="qrcode-container">
        <image class="qrcode" src="{{qrcodeUrl}}" mode="aspectFit" wx:if="{{qrcodeUrl}}" binderror="onQrcodeError" bindload="onQrcodeLoad"></image>
        <view class="qrcode-loading" wx:if="{{!qrcodeUrl || qrcodeLoading}}">
          <text class="loading-text">小程序码加载中...</text>
        </view>
        <view class="qrcode-error" wx:if="{{qrcodeError}}">
          <text class="error-text">小程序码加载失败</text>
          <button class="retry-btn" bindtap="retryLoadQrcode">重试</button>
        </view>
      </view>
      <view class="invite-tip">长按小程序码保存到相册，或点击下方按钮分享</view>
      <button class="share-btn" open-type="share">
        <text class="btn-icon">📤</text>
        <text class="btn-text">分享邀请</text>
      </button>
      <button class="close-btn" bindtap="hideInviteModal">
        <text class="btn-icon">❌</text>
        <text class="btn-text">关闭</text>
      </button>
    </view>
  </view>

  <!-- 转分弹窗 -->
  <view class="modal" wx:if="{{showTransferModal}}">
    <view class="modal-content">
      <input class="transfer-input" placeholder="输入转账金额(1-10000)" type="number" bindinput="onTransferAmountInput" />
      <button class="confirm-btn" bindtap="confirmTransfer">
        <text class="btn-icon">💰</text>
        <text class="btn-text">确定转账</text>
      </button>
      <button class="close-btn" bindtap="hideTransferModal">
        <text class="btn-icon">❌</text>
        <text class="btn-text">取消</text>
      </button>
    </view>
  </view>

  <!-- 修改资料弹窗 -->
  <view class="modal" wx:if="{{showProfileModal}}">
    <view class="modal-content profile-modal">
      <view class="modal-title">修改个人资料</view>
      
      <!-- 头像预览和上传区域 -->
      <view class="avatar-upload-section">
        <view class="avatar-preview-container">
          <image class="avatar-preview" src="{{currentUserAvatar}}" mode="aspectFill" bindtap="chooseAvatar"></image>
          <view class="avatar-overlay" bindtap="chooseAvatar">
            <text class="overlay-icon">📷</text>
            <text class="overlay-text">点击更换</text>
          </view>
        </view>
        <button class="change-avatar-btn" bindtap="chooseAvatar">
          <text class="btn-icon">📷</text>
          <text class="btn-text">选择头像</text>
        </button>
      </view>

      <!-- 昵称输入 -->
      <view class="input-section">
        <text class="input-label">昵称</text>
        <input class="profile-input" placeholder="请输入您的昵称" value="{{newNickname}}" bindinput="onNicknameInput" maxlength="20" />
      </view>

      <view class="button-group">
        <button class="confirm-btn" bindtap="confirmUpdateProfile">
          <text class="btn-icon">✅</text>
          <text class="btn-text">保存修改</text>
        </button>
        <button class="close-btn" bindtap="hideProfileModal">
          <text class="btn-icon">❌</text>
          <text class="btn-text">取消</text>
        </button>
      </view>
    </view>
  </view>
</view>
